rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function userDocPath(uid) {
      return /databases/$(database)/documents/users/$(uid);
    }

    function isAdmin() {
      return signedIn()
        && exists(userDocPath(request.auth.uid))
        && get(userDocPath(request.auth.uid)).data.role == "admin";
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function userDocHasOnlyAllowedFields(data) {
      return data.keys().hasOnly(["role", "email", "createdAt", "updatedAt"]);
    }

    // Allow the very first creation of an admin profile by the signed-in user
    // when their user document does not yet exist.
    function canBootstrapAdminUser(userId) {
      return isSelf(userId)
        && !exists(userDocPath(userId))
        && userDocHasOnlyAllowedFields(request.resource.data)
        && request.resource.data.role == "admin"
        && request.resource.data.email == request.auth.token.email;
    }

    function isValidSelfUpdate(newData, existingData) {
      return userDocHasOnlyAllowedFields(newData)
        && newData.role == existingData.role
        && newData.email == existingData.email;
    }

    function validBooking(data) {
      return data.keys().hasOnly([
          "name",
          "email",
          "frame",
          "notes",
          "createdAt",
          "sessionDate",
          "sessionLabel",
          "workshopId",
        ])
        && data.name is string && data.name.size() > 0 && data.name.size() <= 120
        && data.email is string && data.email.size() > 0 && data.email.size() <= 160
        && data.frame is string && data.frame.size() > 0 && data.frame.size() <= 40
        && (!("notes" in data) || (data.notes is string && data.notes.size() <= 1000))
        && (!("sessionDate" in data) || (data.sessionDate is string && data.sessionDate.size() > 0))
        && (!("sessionLabel" in data) || (data.sessionLabel is string && data.sessionLabel.size() <= 120))
        && (!("workshopId" in data) || (data.workshopId is string && data.workshopId.size() > 0))
        && request.resource.data.createdAt == request.time;
    }

    function validCutFlowerBooking(data) {
      return data.keys().hasOnly([
          "customerName",
          "email",
          "phone",
          "occasion",
          "location",
          "status",
          "eventDate",
          "createdAt",
          "updatedAt",
          "classId",
          "sessionId",
          "sessionLabel",
          "attendeeCount",
          "optionLabel",
          "optionValue",
          "attendeeSelections",
          "estimatedTotal",
          "estimatedPerAttendee",
          "notes",
        ])
        && data.customerName is string && data.customerName.size() > 0 && data.customerName.size() <= 120
        && data.email is string && data.email.size() > 0 && data.email.size() <= 160
        && data.phone is string && data.phone.size() > 0 && data.phone.size() <= 40
        && data.occasion is string && data.occasion.size() <= 160
        && data.location is string && data.location.size() <= 200
        && data.status is string && data.status == "new"
        && (!("eventDate" in data) || data.eventDate == null || data.eventDate is timestamp)
        && data.classId is string && data.classId.size() > 0
        && data.sessionId is string && data.sessionId.size() > 0
        && (!("sessionLabel" in data)
          || data.sessionLabel == null
          || (data.sessionLabel is string && data.sessionLabel.size() <= 160))
        && data.attendeeCount is number && data.attendeeCount >= 1 && data.attendeeCount <= 50
        && (!("optionLabel" in data)
          || data.optionLabel == null
          || (data.optionLabel is string && data.optionLabel.size() <= 160))
        && (!("optionValue" in data)
          || data.optionValue == null
          || (data.optionValue is string && data.optionValue.size() <= 160))
        && data.attendeeSelections is list && data.attendeeSelections.size() <= 50
        && data.estimatedTotal is number && data.estimatedTotal >= 0
        && data.estimatedPerAttendee is number && data.estimatedPerAttendee >= 0
        && (!("notes" in data) || (data.notes is string && data.notes.size() <= 1000))
        && data.createdAt == request.time
        && data.updatedAt == request.time;
    }

    function validOrder(data) {
      return data.keys().hasOnly([
          "customer",
          "items",
          "subtotal",
          "shippingCost",
          "shipping",
          "shippingAddress",
          "totalPrice",
          "status",
          "createdAt",
          "orderNumber",
          "trackingLink",
          "paymentStatus",
          "paymentMethod",
          "paymentApprovalStatus",
          "paymentApproval",
          "paymentProof",
          "payfast",
          "paidAt",
          "updatedAt",
          "deliveryMethod",
          "courierName",
        ])
        && data.customer.keys().hasOnly(["fullName", "email", "phone", "address"])
        && data.customer.fullName is string && data.customer.fullName.size() > 0
        && data.customer.email is string && data.customer.email.size() > 0
        && data.customer.phone is string && data.customer.phone.size() > 0
        && data.customer.address is string && data.customer.address.size() > 0
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.keys().hasOnly(["street", "suburb", "city", "province", "postalCode"]))
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.street is string)
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.suburb is string)
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.city is string)
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.province is string)
        && (!("shippingAddress" in data) || data.shippingAddress == null || data.shippingAddress.postalCode is string)
        && (!("shipping" in data) || data.shipping == null || data.shipping.keys().hasOnly(["courierId", "courierName", "courierPrice", "province"]))
        && (!("shipping" in data) || data.shipping == null || (data.shipping.courierId is string || data.shipping.courierId == null))
        && (!("shipping" in data) || data.shipping == null || (data.shipping.courierName is string || data.shipping.courierName == null))
        && (!("shipping" in data) || data.shipping == null || data.shipping.courierPrice is number)
        && (!("shipping" in data) || data.shipping == null || (data.shipping.province is string || data.shipping.province == null))
        && (!("subtotal" in data) || data.subtotal is number)
        && (!("shippingCost" in data) || data.shippingCost is number)
        && data.items is list && data.items.size() > 0
        && data.items.size() <= 40
        && data.totalPrice is number && data.totalPrice >= 0
        && data.status is string
        && data.paymentStatus is string
        && (!("paymentMethod" in data) || data.paymentMethod is string)
        && (!("paymentApprovalStatus" in data) || data.paymentApprovalStatus is string)
        && (!("deliveryMethod" in data) || data.deliveryMethod is string)
        && (!("courierName" in data) || data.courierName is string)
        && (!("updatedAt" in data) || data.updatedAt == null || data.updatedAt is timestamp)
        && (!("paidAt" in data) || data.paidAt == null || data.paidAt is timestamp)
        && (!("payfast" in data) || data.payfast == null || data.payfast is map)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.keys().hasOnly([
            "required",
            "decision",
            "decidedAt",
            "decidedByUid",
            "decidedByEmail",
            "note",
          ]))
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.required is bool)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.decision is string)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.decidedAt == null || data.paymentApproval.decidedAt is timestamp)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.decidedByUid == null || data.paymentApproval.decidedByUid is string)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.decidedByEmail == null || data.paymentApproval.decidedByEmail is string)
        && (!("paymentApproval" in data) || data.paymentApproval == null || data.paymentApproval.note == null || data.paymentApproval.note is string)
        && (!("paymentProof" in data) || data.paymentProof == null || data.paymentProof.keys().hasOnly([
            "storagePath",
            "fileName",
            "contentType",
            "size",
            "uploadedAt",
          ]))
        && (!("paymentProof" in data) || data.paymentProof == null || data.paymentProof.storagePath is string)
        && (!("paymentProof" in data) || data.paymentProof == null || data.paymentProof.fileName is string)
        && (!("paymentProof" in data) || data.paymentProof == null || data.paymentProof.contentType is string)
        && (!("paymentProof" in data) || data.paymentProof == null || (data.paymentProof.size is number && data.paymentProof.size > 0 && data.paymentProof.size <= 10485760))
        && (!("paymentProof" in data) || data.paymentProof == null || data.paymentProof.uploadedAt == null || data.paymentProof.uploadedAt is timestamp)
        && (("orderNumber" in data) ? (data.orderNumber is number && data.orderNumber >= 1000) : true)
        && (("trackingLink" in data) ? (data.trackingLink is string || data.trackingLink == null) : true)
        && request.resource.data.createdAt == request.time;
    }

    function paymentApprovalDecision(data) {
      return ("paymentApprovalStatus" in data)
        ? data.paymentApprovalStatus
        : (
          ("paymentApproval" in data)
            && data.paymentApproval != null
            && ("decision" in data.paymentApproval)
              ? data.paymentApproval.decision
              : "pending"
        );
    }

    function eftStatusAllowed(data) {
      return !(
          ("paymentMethod" in data)
          && data.paymentMethod == "eft"
          && paymentApprovalDecision(data) != "approved"
        )
        || ["pending-payment-approval", "payment-rejected", "cancelled"].hasAny([data.status]);
    }

    match /users/{userId} {
      allow get: if isSelf(userId) || isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin()
        || canBootstrapAdminUser(userId)
        || (isSelf(userId)
          && userDocHasOnlyAllowedFields(request.resource.data)
          && request.resource.data.role == "customer");

      allow update: if (isSelf(userId) && isValidSelfUpdate(request.resource.data, resource.data))
        || isAdmin();

      allow delete: if isAdmin();
    }

    match /products/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /productCategories/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /workshops/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /events/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /cutFlowerBookings/{document=**} {
      allow create: if isAdmin() || validCutFlowerBooking(request.resource.data);
      allow read, update, delete: if isAdmin();
    }

    match /cutFlowerClasses/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /bookings/{bookingId} {
      allow create: if validBooking(request.resource.data);
      allow read, update, delete: if isAdmin();
    }

    match /orders/{orderId} {
      allow create: if validOrder(request.resource.data);
      allow read, delete: if isAdmin();
      allow update: if isAdmin() && eftStatusAllowed(request.resource.data);
    }

    match /config/{document=**} {
      allow read: if true;
    }

    match /courierOptions/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /config/orderCounter {
      allow read: if true;

      allow create: if request.resource.data.keys().hasOnly(["value"])
        && request.resource.data.value is number
        && request.resource.data.value >= 1000;

      allow update: if request.resource.data.keys().hasOnly(["value"])
        && request.resource.data.value is number
        && resource.data.value is number
        && request.resource.data.value == resource.data.value + 1;

      allow delete: if false;
    }

    match /{document=**} {
      allow read, write: if signedIn();
    }
  }
}
